# P05.1: Core Client + Middleware Hardening
_Complete_

**Status**
- Done (2026-02-09)

**Goal**
Close post-P05 correctness gaps discovered in review and make core client behavior deterministic and spec-conformant before P06+.

**Why this phase exists**
P05 delivered the baseline client/middleware implementation, but a few behaviors are not yet aligned with `spec/01-unified-llm-spec.md` and P04/P05 acceptance depth.

**Planned Changes**
1. Deterministic provider selection from env:
- Make `Client::from_env()` provider registration order deterministic.
- Ensure default provider selection is deterministic and explicit.

2. Fail-fast env client construction:
- Make `Client::from_env()` return `ConfigurationError` when zero providers are discovered.
- Keep request-time `ConfigurationError` behavior when a resolved provider is missing.

3. Runtime default-client overrides:
- Replace one-shot default-client storage with runtime-replaceable storage.
- Preserve lazy initialization from env while allowing `set_default_client()` to override after initialization.

4. SSE parser stream-end correctness:
- Fix `SseParser::finish()` so trailing events without terminal newline/blank boundary are not dropped.
- Add targeted tests for chunk boundaries and terminal flush behavior.

5. Acceptance-level test hardening for P04/P05:
- Add tests for deterministic provider selection and fail-fast `from_env` behavior.
- Add stronger SSE parser edge-case tests beyond happy-path parsing.
- Add stream accumulator parity tests for multi-segment text/tool/reasoning assembly.

6. Status/terminology cleanup:
- Remove incorrect "Implemented in P06" marker from `catalog.rs` until P06 is actually completed.

**Out of Scope**
- Provider adapter implementations (P08-P10).
- High-level generate/stream tool loop APIs (P07).
- Full model catalog implementation (P06).

**Deliverables**
- Updated `client`, `provider`, and `utils::sse` implementations.
- Expanded deterministic unit tests covering the above behaviors.
- Updated roadmap/spec alignment notes where applicable.

**Acceptance**
- `Client::from_env()` is deterministic and fails fast when no providers are configured.
- `set_default_client()` can override the module default at runtime.
- SSE trailing event flush is correct with and without terminal newline.
- Added tests fail on previous behavior and pass with new behavior.

**Completed**
1. Deterministic provider factory iteration implemented using registration-order storage.
2. `Client::from_env()` now fails fast with `ConfigurationError` when no adapters are discovered.
3. Module default client storage is runtime-replaceable; `set_default_client()` now overrides after initialization.
4. `SseParser::finish()` now flushes trailing non-newline-terminated events correctly.
5. Added acceptance-level unit tests for P04/P05 edge cases (env routing, default override, SSE fixtures, accumulator parity behavior).
6. Removed premature `catalog.rs` milestone marker for P06.
