# P27.1: Turnstore Foundation and Agent Persistence Hooks (Spec 04 pre-runtime)

**Status**
- In progress (2026-02-10)
- G1 completed: `forge-turnstore` crate scaffolded with core interfaces/shared types/idempotency helpers.
- G2 completed: deterministic `memory` + `fs` backends implemented with append/fork/list/idempotency parity tests.
- G3 completed: `forge-agent` wired to optional turnstore sink with `off`/`best_effort`/`required` modes and turn/tool metadata persistence.
- G4 completed: subagent spawn now emits explicit persisted fork/link record with parent/child context correlation.

**Goal**
Introduce storage abstractions and deterministic non-CXDB implementations before Attractor runtime milestones, and integrate `forge-agent` with optional persistent turn writing and branch linkage.

**Source**
- Spec of record: `spec/04-cxdb-integration-spec.md` (Sections 2, 3.2, 4.1, 4.3, 4.6, 5.1, 5.2, 6 Phase A)
- Agent runtime: `spec/02-coding-agent-loop-spec.md` (Sections 2.4, 2.5, 2.9, 7)
- Vision alignment: `spec/00-vision.md` (`Run store`, traces, auditability)
- CXDB storage model cross-check: `spec/cxdb/architecture.md` (Turn DAG, Blob CAS, Concurrency Model)
- CXDB type/encoding cross-check: `spec/cxdb/type-registry.md` (Core Concepts, Registry Bundle Format, Schema Evolution)
- CXDB API behavior cross-check: `spec/cxdb/http-api.md` (Turns paging with `before_turn_id`, Registry)

**Context**
- `forge-agent` already emits rich turn/event data and supports subagents/checkpoints.
- `forge-attractor` runtime is not yet implemented, so this is the clean insertion point for shared storage contracts.
- CXDB adapter implementation can happen later without changing runtime core contracts.

## Scope
- Create storage abstraction crate(s) for turn DAG operations.
- Add artifact/blob storage extension interfaces for large immutable payloads.
- Add deterministic in-memory implementation for tests.
- Add filesystem-backed implementation for local parity/debugging.
- Integrate `forge-agent` with optional store binding and idempotent append metadata.
- Define shared correlation/link types needed by future Attractor runtime.

## Out of Scope
- CXDB protocol adapter implementation.
- Attractor traversal runtime and handler execution.
- Distributed claim/lease worker coordination implementation.

## Priority 0 (Must-have)

### [x] G1. Add `forge-turnstore` crate with core interfaces and shared types
- Work:
  - Add `TurnStore` interface (`create_context`, `append_turn`, `fork_context`, `get_head`, `list_turns`).
  - Add optional `TypedTurnStore` interface for registry bundle publication.
  - Add optional `ArtifactStore` interface (`put_blob`, `get_blob`, `attach_fs`) for immutable artifact workflows.
  - Add shared turn envelope + correlation metadata models.
  - Keep context/turn identifiers opaque (`String`) at interface level for backend portability.
  - Add deterministic idempotency key helpers for agent/attractor writers.
  - Record CXDB mapping notes in trait docs so adapter authors can cross-check against `spec/cxdb/protocol.md` and `spec/cxdb/http-api.md`.
- Files:
  - `Cargo.toml` (workspace membership)
  - `crates/forge-turnstore/Cargo.toml`
  - `crates/forge-turnstore/src/lib.rs`
  - `crates/forge-turnstore/src/types.rs`
  - `crates/forge-turnstore/src/store.rs`
- DoD:
  - `forge-turnstore` compiles independently and has stable public contracts.

### [x] G2. Add deterministic non-CXDB implementations (`memory` + optional `fs`)
- Work:
  - Implement in-memory store suitable for parallel-safe tests.
  - Implement optional filesystem-backed store for local parity and offline inspection.
  - Ensure idempotent append behavior is consistent across both implementations.
  - Ensure artifact/blob behavior is consistent across both implementations when enabled.
  - Mirror CXDB invariants where practical (single-parent turns, head progression, CAS-like dedup semantics) for parity confidence.
- Files:
  - `crates/forge-turnstore/src/memory.rs`
  - `crates/forge-turnstore/src/fs.rs`
  - `crates/forge-turnstore/tests/idempotency.rs`
- DoD:
  - Same append/fork/list behavior is validated in tests for memory and filesystem stores.

### [x] G3. Integrate `forge-agent` with optional turnstore writer
- Work:
  - Add `SessionConfig`/constructor wiring for optional store sink + failure mode (`off`, `best_effort`, `required`).
  - Persist session lifecycle and all turn append points through store interface.
  - Persist tool call start/end metadata with deterministic idempotency keys.
- Files:
  - `crates/forge-agent/src/config.rs`
  - `crates/forge-agent/src/session.rs`
  - `crates/forge-agent/src/tools/registry.rs`
- DoD:
  - With sink disabled, behavior is unchanged.
  - With sink enabled, agent turns are persisted and queryable via store API.

### [x] G4. Add subagent branch linkage persistence
- Work:
  - Persist explicit subagent fork/link records at spawn time.
  - Include correlation fields (`session_id`, `parent_turn`, `child_context_id`, `thread_key`).
- Files:
  - `crates/forge-agent/src/session.rs`
  - `crates/forge-agent/tests/conformance_runtime_behaviors.rs`
- DoD:
  - Subagent causality is reconstructable purely from persisted records.

## Priority 1 (Strongly recommended)

### [ ] G5. Add Attractor-facing storage contracts (interfaces only)
- Work:
  - Add Attractor-side storage contract module (run/stage/checkpoint record writer interfaces) that depends only on `forge-turnstore` types.
  - Add run/stage correlation schema types for upcoming runtime modules.
- Files:
  - `crates/forge-attractor/src/storage/mod.rs`
  - `crates/forge-attractor/src/storage/types.rs`
- DoD:
  - P28 runtime modules can be implemented directly against these interfaces.

### [ ] G6. Add deterministic integration tests and docs
- Work:
  - Add agent integration tests running against memory store and filesystem store.
  - Add cursor/list semantics tests covering `before_turn_id` paging behavior in backend-agnostic contract tests.
  - Document how to enable/disable persistence mode in tests.
- Files:
  - `crates/forge-agent/tests/turnstore_integration.rs`
  - `crates/forge-agent/README.md`
- DoD:
  - Persistence contract is test-backed and documented before P28 starts.

## Deliverables
- `forge-turnstore` abstraction crate with deterministic local backends.
- `forge-agent` persistence hooks with subagent linkage support.
- Attractor-facing storage interfaces in place before runtime implementation.

## Execution order
1. G1 interfaces + shared types
2. G2 memory/fs implementations
3. G3 agent integration
4. G4 subagent linkage
5. G5 attractor-side storage contracts
6. G6 tests/docs

## Exit criteria for this file
- Shared storage abstractions exist and are test-backed.
- Agent runtime can persist turns through abstractions without CXDB dependency.
- Attractor runtime can start on storage-first contracts in P28.
